{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Test Session</title>
    <link rel="stylesheet" href="{% static 'basic/stylesTest.css' %}"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
          rel="stylesheet"/>
    <script>
        let responses = [];
        let currentIndex = 0;
        let stimulusText = "";
        let stimulusType = "";
        let charIndex = 0;
        let startTime;
        let responseStartTime;
        let latencies = [];
        let userInput = "";

        let testId = new URLSearchParams(window.location.search).get("test_id");

        async function fetchResponses() {
            const response = await fetch(`/basic/get-responses/?test_id=${testId}`);
            const data = await response.json();
            responses = data.responses;
            startTest();
        }

        function startTest() {
            if (currentIndex < responses.length) {
                stimulusText = responses[currentIndex].stimulus_text;
                stimulusType = responses[currentIndex].stimulus_type;
                charIndex = 0;
                latencies = [];
                userInput = "";

                document.getElementById("stimulus").textContent = "";

                document.getElementById("user-response").textContent = "Your Response: ";

                document.getElementById("keyboard").style.display = "none";
                document.getElementById("numericKeyboard").style.display = "none";


                showNextCharacter();
            } else {
                document.getElementById("stimulus").textContent = "Test Complete!";
            }
        }

        function showNextCharacter() {
            const stimEl = document.getElementById("stimulus");
            const audioEl = document.getElementById("stimulus-audio");
            if (charIndex < stimulusText.length) {
                const currentChar = stimulusText[charIndex];
                stimEl.textContent = currentChar;
                charIndex++;
                const fileName = mapToAudio(currentChar);
                audioEl.src = `/static/basic/${fileName}`;
                audioEl.play().catch(err => console.error("Audio play error:", err))
                setTimeout(showNextCharacter, 2000);
            } else {
                responseStartTime = Date.now();
                stimEl.textContent = '';

                if (stimulusType === "AlphaNumeric") {
                    document.getElementById("keyboard").style.display = "block";
                    document.getElementById("numericKeyboard").style.display = "block";
                }
                if (stimulusType === "Numeric") {
                    document.getElementById("numericKeyboard").style.display = "block";
                }
            }
        }

        function mapToAudio(char) {
            const map = {
                '1': 'One.mp3',
                '2': 'Two.mp3',
                '3': 'Three.mp3',
                '4': 'Four.mp3',
                '5': 'Five.mp3',
                '6': 'Six.mp3',
                '7': 'Seven.mp3',
                '8': 'Eight.mp3',
                '9': 'Nine.mp3',
                'B': 'B (English).mp3',
                'F': 'F (English).mp3',
                'G': 'G (English).mp3',
                'H': 'H (English).mp3',
                'M': 'M (English).mp3',
                'R': 'R (English).mp3',
                'X': 'X (English).mp3',
                'Y': 'Y (English).mp3'
            };
            return map[char] || `${char}.m4a`;
        }

        function submitResponse(choice) {
            let responseId = responses[currentIndex].response_id;
            latencies.push(Date.now() - responseStartTime);

            userInput += choice;

            document.getElementById("user-response").textContent = "Your Response: " + userInput;


            if (userInput.length === stimulusText.length) {
                fetch("/basic/submit-response/", {
                    method: "POST",

                    headers: {"Content-Type": "application/json", "X-CSRFToken": getCSRFToken()},
                    body: JSON.stringify({
                        response_id: responseId,
                        response: userInput,
                        latencies: latencies.join(","),  // Store latencies as a comma-separated string
                    })
                }).then(() => {
                    currentIndex++;
                    if (currentIndex >= responses.length) {
                        // Redirect to completion page when test ends
                        window.location.href = "/basic/test/complete/";
                    } else {
                        startTest();
                    }
                });

            }
        }

        function getCSRFToken() {

            return document.cookie
                .split("; ")
                .find((row) => row.startsWith("csrftoken="))

                ?.split("=")[1];
        }

        window.onload = fetchResponses;
    </script>
</head>


<body>
    <h1>Test Session</h1>
    <p id="stimulus"></p>
    <p id="user-response">Your Response:</p>
    <audio id="stimulus-audio"></audio>
</body>

<div class="button-container">
    <div id = "numericKeyboard" style="display: none;" class="number-buttons">

        <button onclick="submitResponse('1')">1</button>
        <button onclick="submitResponse('2')">2</button>
        <button onclick="submitResponse('3')">3</button>
        <button onclick="submitResponse('4')">4</button>
        <button onclick="submitResponse('5')">5</button>
        <button onclick="submitResponse('6')">6</button>
        <button onclick="submitResponse('7')">7</button>
        <button onclick="submitResponse('9')">9</button>

    </div>

    <div id = "keyboard"  style="display: none;" class="letter-buttons">

        <button onclick="submitResponse('B')">B</button>
        <button onclick="submitResponse('H')">H</button>
        <button onclick="submitResponse('G')">G</button>
        <button onclick="submitResponse('F')">F</button>
        <button onclick="submitResponse('M')">M</button>
        <button onclick="submitResponse('R')">R</button>
        <button onclick="submitResponse('X')">X</button>
        <button onclick="submitResponse('Y')">Y</button>
    </div>
</div>

</html>